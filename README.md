# Panorama - a statistics plugin for Pelican

[![Travis CI Status](https://travis-ci.org/romainx/panorama.svg?branch=master)](https://travis-ci.org/romainx/panorama)
[![Coverage Status](https://coveralls.io/repos/romainx/panorama/badge.png)](https://coveralls.io/r/romainx/panorama)

## Overview

**Panorama** is a [Pelican][LK_PELIC] plugin to generate **statistics from blog posts** (number of posts per year, categories and so on) and display them as **beautiful charts**.

No more talking, see:

- the [example page](http://cdn.rawgit.com/romainx/panorama/master/tests/test_output/all_charts.html),
- a [live example](http://aubonroman.com/stats.html),
- or a screenshot below

![Panorama screenshot](panorama_screenshot.png "Panorama screenshot")

### Functional overview

Produce statistics based on posts metadata and display them by using several charts.
The mapping between data and charts is done by configuration (YAML file).

Metadata data used:

	Title: My super title
	Date: 2010-12-03 10:20
	Category: Python
	Tags: pelican, publishing

### Technical overview

This plugin uses:

- The Pelican [plugins feature](http://docs.getpelican.com/en/latest/plugins.html).
- The [Python Wrapper for NVD3][LK_PNVD3].
- The [Pandas Data Analysis Library][LK_PANDA].

### Design

Some design elements:

- The plugin mechanisms using [blinker](https://pypi.python.org/pypi/blinker).
- A `DataFactory` using article metadata to produce statistical data. Data is stored in [Pandas][LK_PANDA] objects (`DataFrame` and `Series`), in consequence data can be manipulated by all the powerful tools provided by the library.
- A `ChartFactory` using statistical data to render charts. Charts coming from the [Python Wrapper for NVD3][LK_PNVD3].
- A `ConfFactory` to map data to charts. Part of the configuration is accessible through a YAML configuration file.

Generated charts are available in the Pelican `context` (holding the name `panorama_charts`) and can be used by any [Jinja](http://jinja.pocoo.org/) Pelican template to be integrated in the blog.

## Installation

### Get the plugin

The most convenient way is to clone the repository, but the distribution can also be downloaded and extracted.
*Note: The root folder of the Panorama distribution will be named `PANORAMA_DIR` in the rest of this chapter.*

### Install plugin dependencies

It is recommended to use `virtualenv` see the section "Development environment installation" for more details.

```bash
$ pip install -r requirements.txt
```

### Add NVD3 dependencies to your template

Panorama generates HTML content requiring javascript and CSS to display.

Download the following files from [NVD3](http://nvd3.org):

- `nv.d3.min.js`
- `nv.d3.css`

Download the following file from [D3JS](http://d3js.org)

- `d3.zip`

Create a `panorama` directory in `themes/<your_theme>/static/`.
Put them in this directory `themes/<your_theme>/static/panorama/` as described below

```bash
	|- d3
	|   |-- d3.js
	|   |-- d3.min.js
	|   |-- LICENSE
	|- nvd3
	|   |-- nv.d3.min.js
	|   |-- src	
	|       |-- nv.d3.css
```

### Declare the plugin in the Pelican configuration

These settings are made in the Pelican configuration file (`pelicanconf.py`). 

In order to load the plugin you will need to specify the location where plugins are stored and which plugins are used. Assuming this is the first time plugins are used with Pelican, the configuration should look like this:

```python
PLUGIN_PATH = 'plugins'
PLUGINS = ['panorama']
```
Note: `PLUGIN_PATH` has to refer to the location where the Panorama plugin is stored, i.e. `PANORAMA_DIR`. For example, use `../panorama` if the panorama distribution is extracted at the same level than your Pelican site directory. Either the absolute path or the relative path to the plugin directory can be used in the settings file.

Next, it is required to configure the `DIRECT_TEMPLATES` setting. It tells Pelican which templates are to be used directly to render content. It is necessary to add the page that will display Panorama stats, let's call it `stats.html`.

```python
DIRECT_TEMPLATES = (('index', 'tags', 'categories', 'authors', 'archives', 'stats'))
```
If you already have this setting in your configuration file, you simply need to append `stats` at the end.

### Create a template

The last step is to use data generated by Panorama in a template in order to display charts. A simple example is given in the `template/test_page.html` file.
This page has to match the name declared in the `DIRECT_TEMPLATES` setting, so it is called `stats.html` and created in the `themes/<your_theme>/template` directory. Here is a basic example iterating over the dictionary of results. However, the preferred way to integrate charts is to get each by its key from the `panorama_charts` dictionary in order to master the way it will be displayed.
Do not forget to add the heading block to reference NVD3 dependencies (CSS + JS), this block is not added automatically.

```jinja
{% extends 'base.html' %}
{% block title %}Stats - {{ super() }}{% endblock title %}
{% block content %}
<link href="/theme/panorama/nvd3/src/nv.d3.css" rel="stylesheet"/>
<script src="/theme/panorama/d3/d3.min.js"></script>
<script src="/theme/panorama/nvd3/nv.d3.min.js"></script>

<section id="content" >
    <div class="body">
        <header>
          <h1>Stats</h1>
        </header>
        <div class="entry-content">
				{% for chart in panorama_charts.values() %}
        <h2>{{ chart.name }}</h2>
        {{ chart.container }}
        {{ chart.htmlcontent }}
        {% endfor %}
				</div>
    </div>
</section>
{% endblock %}
```
## Configuration

### Principle

Panorama loads its configuration from a YAML file. It tries to load a `panorama.yml` file located in the Pelican root directory. If this file does not exist, it uses the `default.yml` file located in the plugin directory.

### Default configuration

The default configuration provides 3 configurations that can be used as is :

- `nb_article_by_year`: Display the number of articles by year as a bar chart.
- `nb_article_by_category`: Display the number of articles by category as a pie chart.
- `nb_article_by_category_year`: Display the number of articles by category (one series by category) and by year as a multi bar chart.

### Custom configuration

A configuration is composed of:

- a `chart_id`: It is the name used to reference the chart. This name will be used in the template to access to the chart from `panorama_charts` in the Pelican context.
- a `producer`: It defines the source of the data, it is composed of:
	- a `function_name`: The name of the function to call and its potential arguments `args`.
- a `renderer`: It defines the way data are displayed, it is composed of:
	- a `class_name`: The class of the chart to instantiate.

#### Producer

The available `producer` are:

- `count_article_by_column`: Count the number of articles by the specified column. For example, if the specified `column`` is "category", it will group articles by category and count the number of articles in each category.
	- `column`: the name of the column used to group data.
- `count_article_by_year`: Count the number of articles by year. It will group articles by year and count the number of articles for each year.
- `count_article_by_column_by_year`: Count the number of articles by year for each group. For example, if the specified `column` is "category", it will group articles by category and count, for each category, the number of articles by year.
	- `column`: the name of the column used to group data.
- top_article: Return the top elements of a group. For example, if the specified `column` is "category" and `top` is "3", it will group articles by category and return the 3 categories with the more articles. 
	- `column`: the name of the column used to group data.
	- `top`: the number of items to return

## How to

### Run tests

Go to the Panorama root project directory and launch the following command:

```bash
$ python -m unittest discover
```

### Install the development environment

#### Installing virtualenv

```bash
$ pip install virtualenv
```

Configure the `.bash_profile` file

```bash
# pip should only run if there is a virtualenv currently activated
export PIP_REQUIRE_VIRTUALENV=true
# cache pip-installed packages to avoid re-downloading
export PIP_DOWNLOAD_CACHE=$HOME/.pip/cachecontent/*
```

Source the file

```bash
$ source .bash_profile
```

#### Creating and activating the virtual environment

```bash
$ mkdir virtualenvs
$ cd virtualenvs
$ virtualenv v_panorama
```

Activate the environment

```bash
$ source $HOME/virtualenvs/v_panorama/bin/activate
```

#### Install the requirements

Go to the Git folder and install the requirements.

```bash
$ pip install -r requirements.txt
$ pip install -r dev-requirements.txt
```

[LK_PNVD3]: https://github.com/areski/python-nvd3
[LK_PANDA]: http://pandas.pydata.org
[LK_PELIC]: https://github.com/getpelican/pelican